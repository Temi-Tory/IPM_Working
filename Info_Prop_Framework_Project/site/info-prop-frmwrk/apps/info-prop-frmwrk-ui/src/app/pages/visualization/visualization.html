<div class="page-container">
  <!-- No Graph Loaded Warning -->
  @if (!isGraphLoaded()) {
    <mat-card class="page-card warning-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>warning</mat-icon>
          No Graph Loaded
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p>Please upload a graph file first to visualize the network.</p>
        <button mat-raised-button color="primary" routerLink="/upload">
          <mat-icon>upload_file</mat-icon>
          Upload Graph
        </button>
      </mat-card-content>
    </mat-card>
  } @else {
    
    <!-- Visualization Controls -->
    <mat-card class="page-card controls-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>tune</mat-icon>
          Visualization Controls
        </mat-card-title>
        <mat-card-subtitle>Configure layout, highlighting, and display options</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="controls-grid">
          
          <!-- Layout Selection -->
          <div class="control-group">
            <span class="control-label">Layout Algorithm</span>
            <mat-select
              [(value)]="selectedLayout"
              (selectionChange)="onLayoutChange()"
              class="layout-select">
              @for (layout of layoutOptions; track layout.value) {
                <mat-option [value]="layout.value" [matTooltip]="layout.description">
                  {{ layout.label }}
                </mat-option>
              }
            </mat-select>
          </div>

          <!-- Highlighting Mode -->
          <div class="control-group">
            <span class="control-label">Highlighting</span>
            <mat-select
              [(value)]="highlightMode"
              (selectionChange)="onHighlightModeChange()"
              class="highlight-select">
              @for (option of highlightOptions; track option.value) {
                <mat-option [value]="option.value">
                  {{ option.label }}
                </mat-option>
              }
            </mat-select>
          </div>

          <!-- Diamond Focus Controls -->
          @if (availableDiamonds().length > 0) {
            <div class="control-group">
              <span class="control-label">Focus on Diamond</span>
              <mat-select
                [(value)]="focusedDiamond"
                (selectionChange)="onDiamondFocusChange()"
                class="diamond-select">
                <mat-option value="">None</mat-option>
                @for (diamond of availableDiamonds(); track diamond.join_node) {
                  <mat-option [value]="diamond.join_node">
                    Diamond {{ diamond.join_node }} ({{ diamond.subgraph_size }} nodes)
                  </mat-option>
                }
              </mat-select>
            </div>
          }

          <!-- Subgraph Highlighting -->
          <div class="control-group">
            <span class="control-label">Subgraph Highlighting</span>
            <div class="subgraph-controls">
              <div class="node-input-group">
                <mat-form-field appearance="outline" class="node-input">
                  <mat-label>From Node</mat-label>
                  <input matInput type="number" [(ngModel)]="fromNode" placeholder="Start node">
                </mat-form-field>
                <mat-form-field appearance="outline" class="node-input">
                  <mat-label>To Node</mat-label>
                  <input matInput type="number" [(ngModel)]="toNode" placeholder="End node">
                </mat-form-field>
                <button mat-button (click)="highlightPath()" [disabled]="!fromNode || !toNode">
                  <mat-icon>route</mat-icon>
                  Highlight Path
                </button>
              </div>
              <div class="multi-node-group">
                <mat-form-field appearance="outline" class="multi-node-input">
                  <mat-label>Multiple Nodes</mat-label>
                  <input matInput [(ngModel)]="multiNodeInput" placeholder="e.g., 1,5,10,15">
                </mat-form-field>
                <button mat-button (click)="highlightMultipleNodes()" [disabled]="!multiNodeInput">
                  <mat-icon>scatter_plot</mat-icon>
                  Highlight Nodes
                </button>
              </div>
              <button mat-button (click)="clearCustomHighlights()" *ngIf="hasCustomHighlights()">
                <mat-icon>clear</mat-icon>
                Clear Custom Highlights
              </button>
            </div>
          </div>

          <!-- Display Options -->
          <div class="control-group">
            <span class="control-label">Display Options</span>
            <div class="checkbox-group">
              <mat-chip-set>
                <mat-chip
                  [highlighted]="showNodeLabels()"
                  (click)="showNodeLabels.set(!showNodeLabels()); onNodeLabelsChange()">
                  <mat-icon>label</mat-icon>
                  Node Labels
                </mat-chip>
                <mat-chip
                  [highlighted]="showEdgeLabels()"
                  (click)="showEdgeLabels.set(!showEdgeLabels()); onEdgeLabelsChange()">
                  <mat-icon>linear_scale</mat-icon>
                  Edge Labels
                </mat-chip>
              </mat-chip-set>
            </div>
          </div>

        </div>

        <mat-divider></mat-divider>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button
            mat-raised-button
            color="primary"
            (click)="generateVisualization()"
            [disabled]="isGeneratingDot()">
            <ng-container>
              @if (isGeneratingDot()) {
                <mat-spinner diameter="20"></mat-spinner>
                Generating...
              } @else {
                <mat-icon>refresh</mat-icon>
                Generate Visualization
              }
            </ng-container>
          </button>

          <button 
            mat-stroked-button 
            (click)="downloadDotFile()"
            [disabled]="!dotString()">
            <mat-icon>download</mat-icon>
            Download DOT
          </button>

          <button 
            mat-stroked-button 
            (click)="exportVisualization()"
            [disabled]="!dotString()">
            <mat-icon>image</mat-icon>
            Export Image
          </button>



          <button 
            mat-button 
            (click)="resetView()">
            <mat-icon>restore</mat-icon>
            Reset View
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Network Information -->
    <mat-card class="page-card info-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>info</mat-icon>
          Network Information
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="network-info">
          <div class="info-item">
            <span class="info-label">Nodes:</span>
            <span class="info-value">{{ nodeCount() }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Edges:</span>
            <span class="info-value">{{ edgeCount() }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Layout:</span>
            <span class="info-value">{{ selectedLayout() }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Highlighting:</span>
            <span class="info-value">{{ highlightMode() }}</span>
          </div>
          @if (focusedDiamond()) {
            <div class="info-item">
              <span class="info-label">Focused Diamond:</span>
              <span class="info-value">{{ focusedDiamond() }}</span>
            </div>
          }
          @if (hasCustomHighlights()) {
            <div class="info-item">
              <span class="info-label">Custom Highlights:</span>
              <span class="info-value">{{ getCustomHighlightCount() }} nodes</span>
            </div>
          }
        </div>

        <!-- Highlighting Legend -->
        @if (highlightMode() !== 'none' && nodeHighlights().length > 0) {
          <mat-divider></mat-divider>
          <div class="highlight-legend">
            <h4>Color Legend</h4>
            <div class="legend-items">
              @if (highlightMode() === 'node-types') {
                <div class="legend-item">
                  <div class="legend-color" style="background-color: #4CAF50;"></div>
                  <span>Source Nodes</span>
                </div>
                <div class="legend-item">
                  <div class="legend-color" style="background-color: #FF9800;"></div>
                  <span>Fork Nodes</span>
                </div>
                <div class="legend-item">
                  <div class="legend-color" style="background-color: #2196F3;"></div>
                  <span>Join Nodes</span>
                </div>
              }
              @if (highlightMode() === 'diamond-structures') {
                <div class="legend-item">
                  <div class="legend-color" style="background-color: #E91E63;"></div>
                  <span>Diamond Structure Nodes</span>
                </div>
              }
              @if (highlightMode() === 'iteration-levels') {
                <div class="legend-item">
                  <div class="legend-color gradient"></div>
                  <span>Iteration Levels (Color Gradient)</span>
                </div>
              }
              @if (focusedDiamond()) {
                <div class="legend-item">
                  <div class="legend-color" style="background-color: #FF5722;"></div>
                  <span>Focused Diamond {{ focusedDiamond() }}</span>
                </div>
              }
              @if (hasCustomHighlights()) {
                <div class="legend-item">
                  <div class="legend-color" style="background-color: #9C27B0;"></div>
                  <span>Custom Highlighted Nodes</span>
                </div>
                @if (highlightedPath().length > 0) {
                  <div class="legend-item">
                    <div class="legend-color" style="background-color: #00BCD4;"></div>
                    <span>Path Highlighting</span>
                  </div>
                }
              }
            </div>
          </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- Enhanced Visualization Display with Node Details -->
    <div class="visualization-layout">
      <!-- Main Visualization Card -->
      <mat-card class="page-card visualization-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>scatter_plot</mat-icon>
            Network Visualization
          </mat-card-title>
          <mat-card-subtitle>Interactive D3 network visualization - Click nodes for details</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <!-- Enhanced Visualization Controls -->
          <div class="viz-toolbar">
            <div class="viz-controls">
              <mat-chip-set>
                <mat-chip
                  [highlighted]="showSourceNodes()"
                  (click)="showSourceNodes.set(!showSourceNodes()); updateVisualization()">
                  <mat-icon>radio_button_checked</mat-icon>
                  Sources
                </mat-chip>
                <mat-chip
                  [highlighted]="showSinkNodes()"
                  (click)="showSinkNodes.set(!showSinkNodes()); updateVisualization()">
                  <mat-icon>stop_circle</mat-icon>
                  Sinks
                </mat-chip>
                <mat-chip
                  [highlighted]="showForkNodes()"
                  (click)="showForkNodes.set(!showForkNodes()); updateVisualization()">
                  <mat-icon>call_split</mat-icon>
                  Forks
                </mat-chip>
                <mat-chip
                  [highlighted]="showJoinNodes()"
                  (click)="showJoinNodes.set(!showJoinNodes()); updateVisualization()">
                  <mat-icon>call_merge</mat-icon>
                  Joins
                </mat-chip>
                <mat-chip
                  [highlighted]="showIterations()"
                  (click)="showIterations.set(!showIterations()); updateVisualization()">
                  <mat-icon>layers</mat-icon>
                  Iterations
                </mat-chip>
                <mat-chip
                  [highlighted]="showDiamonds()"
                  (click)="showDiamonds.set(!showDiamonds()); updateVisualization()">
                  <mat-icon>diamond</mat-icon>
                  Diamonds
                </mat-chip>
              </mat-chip-set>
            </div>
            
            <div class="zoom-controls">
              <button mat-icon-button (click)="resetZoom()" matTooltip="Reset Zoom">
                <mat-icon>zoom_out_map</mat-icon>
              </button>
              <button mat-icon-button (click)="fitToScreen()" matTooltip="Fit to Screen">
                <mat-icon>fit_screen</mat-icon>
              </button>
              <mat-slider
            class="zoom-slider"
            [min]="0.1"
            [max]="3.0"
            [step]="0.1"
            [(ngModel)]="zoomLevel"
            (ngModelChange)="onZoomChange($event)"
            matTooltip="Zoom Level">
          </mat-slider>

            </div>
          </div>

          <!-- Container is ALWAYS present, content changes based on state -->
          <div class="visualization-container">
            <div #dotContainer class="dot-container">
              <!-- Content varies based on state -->
              @if (isGeneratingDot()) {
                <div class="loading-container">
                  <mat-spinner></mat-spinner>
                  <p>Generating visualization...</p>
                </div>
              } @else if (dotString()) {
                <!-- Visualization will be rendered here by the service -->
              } @else {
                <div class="no-visualization">
                  <mat-icon>scatter_plot</mat-icon>
                  <h3>No Visualization Generated</h3>
                  <p>Click "Generate Visualization" to create an interactive DOT graph of your network.</p>
                  <button
                    mat-raised-button
                    color="primary"
                    (click)="generateVisualization()">
                    <mat-icon>play_arrow</mat-icon>
                    Generate Now
                  </button>
                </div>
              }
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Rich Node Details Panel -->
      <mat-card class="page-card node-details-card" *ngIf="selectedNodeInfo()">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>info</mat-icon>
            Node {{ selectedNodeInfo()?.nodeId }} Details
          </mat-card-title>
          <button mat-icon-button (click)="clearNodeSelection()" class="close-button">
            <mat-icon>close</mat-icon>
          </button>
        </mat-card-header>
        <mat-card-content>
          <div class="node-details-content">
            <!-- Basic Node Information -->
            <div class="detail-section">
              <h4>Basic Information</h4>
              <div class="detail-grid">
                <div class="detail-item">
                  <span class="detail-label">Node ID:</span>
                  <span class="detail-value node-id">{{ selectedNodeInfo()?.nodeId }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Type:</span>
                  <mat-chip [class]="'node-type-' + selectedNodeInfo()?.nodeType">
                    {{ selectedNodeInfo()?.nodeType | titlecase }}
                  </mat-chip>
                </div>
                <div class="detail-item">
                  <span class="detail-label">In-Degree:</span>
                  <span class="detail-value">{{ selectedNodeInfo()?.inDegree }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Out-Degree:</span>
                  <span class="detail-value">{{ selectedNodeInfo()?.outDegree }}</span>
                </div>
              </div>
            </div>

            <!-- Probability Information -->
            <div class="detail-section" *ngIf="selectedNodeInfo()?.['isPriorAvailable'] || selectedNodeInfo()?.['hasResults']">
              <h4>Probability Values</h4>
              <div class="detail-grid">
                <div class="detail-item" *ngIf="selectedNodeInfo()?.['isPriorAvailable']">
                  <span class="detail-label">Prior Probability:</span>
                  <span class="detail-value probability-value">
                    {{ selectedNodeInfo()?.priorProbability | number:'1.4-4' }}
                  </span>
                </div>
                <div class="detail-item" *ngIf="selectedNodeInfo()?.['hasResults']">
                  <span class="detail-label">Reachability Value:</span>
                  <span class="detail-value probability-value highlight">
                    {{ selectedNodeInfo()?.reachabilityValue | number:'1.4-4' }}
                  </span>
                </div>
                <div class="detail-item" *ngIf="selectedNodeInfo()?.['hasResults'] && selectedNodeInfo()?. ['isPriorAvailable']">
                  <span class="detail-label">Difference:</span>
                  <span class="detail-value"
                        [class]="(selectedNodeInfo()?.reachabilityValue! - selectedNodeInfo()?.priorProbability!) > 0 ? 'positive-diff' : 'negative-diff'">
                    {{ (selectedNodeInfo()?.reachabilityValue! - selectedNodeInfo()?.priorProbability!) | number:'+1.4-4' }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Network Position -->
            <div class="detail-section">
              <h4>Network Position</h4>
              <div class="detail-grid">
                <div class="detail-item" *ngIf="selectedNodeInfo()?.iterationSet !== null">
                  <span class="detail-label">Iteration Set:</span>
                  <span class="detail-value">{{ selectedNodeInfo()?.iterationSet }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Connectivity Ratio:</span>
                  <span class="detail-value">{{ selectedNodeInfo()?.['connectivityRatio'] | number:'1.2-2' }}</span>
                </div>
                <div class="detail-item" *ngIf="selectedNodeInfo()?.['isHighlyConnected']">
                  <span class="detail-label">Status:</span>
                  <mat-chip color="accent">Highly Connected</mat-chip>
                </div>
                <div class="detail-item" *ngIf="selectedNodeInfo()?.['isTerminal']">
                  <span class="detail-label">Status:</span>
                  <mat-chip color="warn">Potential Bottleneck</mat-chip>
                </div>
                <div class="detail-item" *ngIf="selectedNodeInfo()?.['isTerminal']">
                  <span class="detail-label">Status:</span>
                  <mat-chip>Terminal Node</mat-chip>
                </div>
              </div>
            </div>

            <!-- Diamond Memberships -->
            <div class="detail-section" *ngIf="selectedNodeInfo()?.diamondMemberships && selectedNodeInfo()?.diamondMemberships!.length > 0">
              <h4>Diamond Structures</h4>
              <div class="diamond-memberships">
                <mat-chip-set>
                  @for (membership of selectedNodeInfo()?.diamondMemberships; track membership) {
                    <mat-chip>{{ membership }}</mat-chip>
                  }
                </mat-chip-set>
              </div>
            </div>

            <!-- Relationship Actions -->
            <div class="detail-section">
              <h4>Explore Relationships</h4>
              <div class="relationship-actions">
                <button mat-stroked-button
                        (click)="highlightNodeRelationships(selectedNodeInfo()!.nodeId, 'ancestors')"
                        [disabled]="!selectedNodeInfo()?.ancestors || selectedNodeInfo()?.ancestors!.length === 0">
                  <mat-icon>arrow_upward</mat-icon>
                  Highlight Ancestors ({{ selectedNodeInfo()?.ancestors?.length || 0 }})
                </button>
                <button mat-stroked-button
                        (click)="highlightNodeRelationships(selectedNodeInfo()!.nodeId, 'descendants')"
                        [disabled]="!selectedNodeInfo()?.descendants || selectedNodeInfo()?.descendants!.length === 0">
                  <mat-icon>arrow_downward</mat-icon>
                  Highlight Descendants ({{ selectedNodeInfo()?.descendants?.length || 0 }})
                </button>
                <button mat-stroked-button
                        (click)="highlightNodeRelationships(selectedNodeInfo()!.nodeId, 'both')"
                        [disabled]="(!selectedNodeInfo()?.ancestors || selectedNodeInfo()?.ancestors!.length === 0) &&
                                   (!selectedNodeInfo()?.descendants || selectedNodeInfo()?.descendants!.length === 0)">
                  <mat-icon>device_hub</mat-icon>
                  Highlight Both
                </button>
                <button mat-button (click)="clearCustomHighlights()">
                  <mat-icon>clear</mat-icon>
                  Clear Highlights
                </button>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Hover Tooltip -->
    <div class="node-tooltip"
         *ngIf="hoveredNodeInfo()"
         [style.left.px]="hoveredNodeInfo()?.x"
         [style.top.px]="hoveredNodeInfo()?.y">
      <div class="tooltip-content">
        <div class="tooltip-header">
          <strong>Node {{ hoveredNodeInfo()?.nodeId }}</strong>
          <span class="node-type-badge" [class]="'type-' + hoveredNodeInfo()?.details?.nodeType">
            {{ hoveredNodeInfo()?.details?.nodeType }}
          </span>
        </div>
        <div class="tooltip-body">
          <div class="tooltip-item" *ngIf="hoveredNodeInfo()?.details?.isPriorAvailable">
            <span>Prior: {{ hoveredNodeInfo()?.details?.priorProbability | number:'1.3-3' }}</span>
          </div>
          <div class="tooltip-item" *ngIf="hoveredNodeInfo()?.details?.hasResults">
            <span>Reachability: {{ hoveredNodeInfo()?.details?.reachabilityValue | number:'1.3-3' }}</span>
          </div>
          <div class="tooltip-item">
            <span>Connections: {{ hoveredNodeInfo()?.details?.inDegree }}â†’{{ hoveredNodeInfo()?.details?.outDegree }}</span>
          </div>
        </div>
        <div class="tooltip-footer">
          <small>Click for detailed information</small>
        </div>
      </div>
    </div>

    <!-- Layout Information -->
    <mat-card class="page-card help-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>help_outline</mat-icon>
          Layout Algorithms Guide
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="layout-help">
          @for (layout of layoutOptions; track layout.value) {
            <div class="layout-info">
              <h4>{{ layout.label }}</h4>
              <p>{{ layout.description }}</p>
            </div>
          }
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Navigation Actions -->
    <mat-card class="page-card actions-card">
      <mat-card-content>
        <div class="navigation-actions">
          <button mat-stroked-button routerLink="/network-structure">
            <mat-icon>account_tree</mat-icon>
            Network Structure
          </button>
          
          <button mat-stroked-button routerLink="/parameters">
            <mat-icon>tune</mat-icon>
            Configure Parameters
          </button>
          
          <button mat-stroked-button routerLink="/diamond-analysis">
            <mat-icon>diamond</mat-icon>
            Diamond Analysis
          </button>
        </div>
      </mat-card-content>
    </mat-card>

  }
</div>