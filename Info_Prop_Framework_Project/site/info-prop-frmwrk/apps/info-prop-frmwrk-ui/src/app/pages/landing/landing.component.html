<div class="enhanced-upload-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1>
      <mat-icon class="header-icon">upload_file</mat-icon>
      Enhanced File Management
    </h1>
    <div class="tier-badge">
      <mat-icon>speed</mat-icon>
      Phase 2: Advanced Upload & Parameters
    </div>
    <p class="subtitle">Upload, validate, and configure your network data with advanced parameter controls</p>
  </div>

  <!-- File Upload Section -->
  <mat-card class="upload-card" [class.has-file]="currentFile" [class.processing]="isLoading">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>cloud_upload</mat-icon>
        File Upload & Validation
      </mat-card-title>
      <mat-card-subtitle>
        Upload CSV files with comprehensive validation and preview
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Enhanced File Upload Area -->
      <div class="file-upload-area" 
           [class.drag-over]="isDragOver"
           [class.has-file]="currentFile"
           [class.processing]="isLoading"
           (dragover)="onDragOver($event)"
           (dragleave)="onDragLeave($event)"
           (drop)="onDrop($event)"
           (click)="!currentFile && fileInput.click()"
           [tabindex]="currentFile ? -1 : 0"
           role="button"
           [attr.aria-label]="currentFile ? 'File loaded' : 'Upload CSV file'">
        
        <input #fileInput 
               type="file" 
               accept=".csv,.tsv,.txt"
               (change)="onFileSelected($event)"
               style="display: none;">
        
        <div class="upload-content">
          <!-- Upload State Icons -->
          <div class="upload-icon-container">
            <mat-icon class="upload-icon" [class.success]="currentFile && !isLoading" [class.processing]="isLoading">
              {{ isLoading ? 'hourglass_empty' : (currentFile ? 'check_circle' : 'cloud_upload') }}
            </mat-icon>
            <mat-spinner *ngIf="isLoading" diameter="60" class="upload-spinner"></mat-spinner>
          </div>
          
          <!-- Upload Text -->
          <div class="upload-text">
            <h3 *ngIf="!currentFile && !isLoading">Drop your CSV file here</h3>
            <h3 *ngIf="currentFile && !isLoading">{{ currentFile.name }}</h3>
            <h3 *ngIf="isLoading">Processing {{ currentFile?.name }}...</h3>
            
            <p *ngIf="!currentFile && !isLoading" class="upload-hint">
              or click to browse files • Enhanced validation & preview included
            </p>
            <p *ngIf="currentFile && !isLoading" class="file-info">
              {{ formatFileSize(currentFile.size) }} • 
              <span [class]="fileValidation?.isValid ? 'valid' : 'invalid'">
                {{ fileValidation?.isValid ? 'Valid format' : 'Issues detected' }}
              </span>
            </p>
            <p *ngIf="isLoading" class="loading-info">
              Running comprehensive validation and analysis...
            </p>
          </div>
          
          <!-- Action Buttons -->
          <div class="upload-actions">
            <button 
              *ngIf="!currentFile && !isLoading"
              mat-raised-button 
              color="primary" 
              class="browse-button">
              <mat-icon>folder_open</mat-icon>
              Browse Files
            </button>
            
            <div *ngIf="currentFile && !isLoading" class="file-actions">
              <button 
                mat-raised-button 
                color="primary"
                (click)="reprocessFile(); $event.stopPropagation()"
                [disabled]="!fileValidation?.isValid">
                <mat-icon>refresh</mat-icon>
                Reprocess
              </button>
              <button 
                mat-stroked-button 
                color="warn" 
                (click)="clearFile(); $event.stopPropagation()">
                <mat-icon>clear</mat-icon>
                Clear
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Processing Options -->
      <mat-expansion-panel class="processing-options" [expanded]="showAdvancedOptions">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>settings</mat-icon>
            Processing Options
          </mat-panel-title>
          <mat-panel-description>
            Configure file processing and validation behavior
          </mat-panel-description>
        </mat-expansion-panel-header>
        
        <div class="options-content">
          <div class="options-grid">
            <div class="option-item">
              <mat-slide-toggle [(ngModel)]="processingOptions.autoStartStructureAnalysis">
                Auto-start structure analysis
              </mat-slide-toggle>
              <p class="option-description">Automatically run Tier 1 analysis after file upload</p>
            </div>
            
            <div class="option-item">
              <mat-slide-toggle [(ngModel)]="processingOptions.validateDataTypes">
                Strict data validation
              </mat-slide-toggle>
              <p class="option-description">Validate all values are proper probabilities [0,1]</p>
            </div>
            
            <div class="option-item">
              <mat-slide-toggle [(ngModel)]="processingOptions.createBackup">
                Create file session
              </mat-slide-toggle>
              <p class="option-description">Save file session for quick reload</p>
            </div>
            
            <div class="option-item">
              <mat-slide-toggle [(ngModel)]="processingOptions.compressionEnabled">
                Enable compression
              </mat-slide-toggle>
              <p class="option-description">Compress large files for faster processing</p>
            </div>
          </div>
        </div>
      </mat-expansion-panel>

      <!-- Validation Summary -->
      <div class="validation-summary" *ngIf="fileValidation">
        <div class="summary-header">
          <mat-icon [class]="fileValidation.isValid ? 'success' : 'error'">
            {{ fileValidation.isValid ? 'verified' : 'error_outline' }}
          </mat-icon>
          <h3>{{ fileValidation.isValid ? 'Validation Passed' : 'Validation Issues' }}</h3>
        </div>
        
        <!-- Quick Stats -->
        <div class="quick-stats" *ngIf="fileValidation.fileInfo">
          <div class="stat">
            <span class="stat-value">{{ fileValidation.fileInfo.rows | number }}</span>
            <span class="stat-label">Rows</span>
          </div>
          <div class="stat">
            <span class="stat-value">{{ fileValidation.fileInfo.columns | number }}</span>
            <span class="stat-label">Columns</span>
          </div>
          <div class="stat">
            <span class="stat-value">{{ formatFileSize(fileValidation.fileInfo.size) }}</span>
            <span class="stat-label">Size</span>
          </div>
        </div>

        <!-- Issues Summary -->
        <div class="issues-summary" *ngIf="!fileValidation.isValid || fileValidation.warnings.length > 0">
          <div class="error-count" *ngIf="fileValidation.errors.length > 0">
            <mat-icon>error</mat-icon>
            <span>{{ fileValidation.errors.length }} Error{{ fileValidation.errors.length !== 1 ? 's' : '' }}</span>
          </div>
          <div class="warning-count" *ngIf="fileValidation.warnings.length > 0">
            <mat-icon>warning</mat-icon>
            <span>{{ fileValidation.warnings.length }} Warning{{ fileValidation.warnings.length !== 1 ? 's' : '' }}</span>
          </div>
        </div>

        <!-- Export Validation Report -->
        <button 
          mat-stroked-button 
          (click)="exportFileValidation()"
          class="export-validation-btn">
          <mat-icon>download</mat-icon>
          Export Validation Report
        </button>
      </div>

    </mat-card-content>
  </mat-card>

  <!-- File Preview Component -->
  <app-file-preview 
    *ngIf="currentFile && fileContent"
    [file]="currentFile"
    [fileContent]="fileContent"
    [validationResult]="fileValidation">
  </app-file-preview>

  <!-- Parameter Control Component -->
  <app-parameter-control 
    *ngIf="currentFile"
    [showAdvanced]="true"
    [allowBulkEdit]="true"
    (parametersChanged)="onParametersChanged($event)">
  </app-parameter-control>

  <!-- Sample Files Section -->
  <mat-card class="samples-card" *ngIf="!currentFile">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>folder_special</mat-icon>
        Sample Networks
      </mat-card-title>
      <mat-card-subtitle>Download example files to test the framework</mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content>
      <div class="sample-files-grid">
        <div class="sample-file-card" *ngFor="let sample of sampleFiles">
          <div class="sample-header">
            <mat-icon>{{ sample.icon }}</mat-icon>
            <div class="sample-info">
              <h4>{{ sample.name }}</h4>
              <p>{{ sample.description }}</p>
            </div>
          </div>
          <div class="sample-stats">
            <span class="stat">{{ sample.nodes }} nodes</span>
            <span class="stat">{{ sample.complexity }} complexity</span>
          </div>
          <div class="sample-actions">
            <button 
              mat-raised-button 
              color="primary" 
              (click)="downloadSampleFile(sample.type)">
              <mat-icon>download</mat-icon>
              Download
            </button>
            <button 
              mat-stroked-button 
              (click)="previewSample(sample.type)">
              <mat-icon>visibility</mat-icon>
              Preview
            </button>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Analysis Progress Card -->
  <mat-card *ngIf="currentFile && !isLoading && !error" class="progress-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>analytics</mat-icon>
        Analysis Progress
      </mat-card-title>
      <mat-card-subtitle>Track your analysis through different tiers</mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content>
      <div class="progress-overview">
        <div class="progress-stats">
          <div class="stat">
            <span class="stat-value">{{ getProgressPercentage() }}%</span>
            <span class="stat-label">Complete</span>
          </div>
          <div class="stat">
            <span class="stat-value">{{ analysisProgress.currentTier || 1 }}</span>
            <span class="stat-label">Current Tier</span>
          </div>
          <div class="stat">
            <span class="stat-value">{{ fileValidation?.isValid ? 'Valid' : 'Issues' }}</span>
            <span class="stat-label">File Status</span>
          </div>
        </div>
      </div>

      <mat-divider></mat-divider>

      <!-- Enhanced Tier Status -->
      <div class="tier-status">
        <div class="tier-item" [class]="getTierStatus(1)">
          <div class="tier-number">1</div>
          <div class="tier-content">
            <div class="tier-info">
              <h4>Structure Analysis</h4>
              <p>Network topology and basic statistics</p>
            </div>
            <div class="tier-features">
              <span class="feature">Node classification</span>
              <span class="feature">Graph metrics</span>
              <span class="feature">Connectivity analysis</span>
            </div>
          </div>
          <mat-icon class="tier-status-icon">
            {{ getTierStatus(1) === 'complete' ? 'check_circle' : 
               getTierStatus(1) === 'current' ? 'hourglass_empty' : 'radio_button_unchecked' }}
          </mat-icon>
        </div>

        <div class="tier-item" [class]="getTierStatus(2)">
          <div class="tier-number">2</div>
          <div class="tier-content">
            <div class="tier-info">
              <h4>Diamond Analysis</h4>
              <p>Diamond structure identification and classification</p>
            </div>
            <div class="tier-features">
              <span class="feature">Pattern detection</span>
              <span class="feature">Classification</span>
              <span class="feature">Optimization insights</span>
            </div>
          </div>
          <mat-icon class="tier-status-icon">
            {{ getTierStatus(2) === 'complete' ? 'check_circle' : 
               getTierStatus(2) === 'current' ? 'hourglass_empty' : 'radio_button_unchecked' }}
          </mat-icon>
        </div>

        <div class="tier-item" [class]="getTierStatus(3)">
          <div class="tier-number">3</div>
          <div class="tier-content">
            <div class="tier-info">
              <h4>Reachability Analysis</h4>
              <p>Belief propagation and probability calculations</p>
            </div>
            <div class="tier-features">
              <span class="feature">Belief propagation</span>
              <span class="feature">Monte Carlo validation</span>
              <span class="feature">Parameter sensitivity</span>
            </div>
          </div>
          <mat-icon class="tier-status-icon">
            {{ getTierStatus(3) === 'complete' ? 'check_circle' : 
               getTierStatus(3) === 'current' ? 'hourglass_empty' : 'radio_button_unchecked' }}
          </mat-icon>
        </div>
      </div>

      <!-- Quick Navigation -->
      <div class="quick-nav" *ngIf="analysisProgress.tier1Complete">
        <mat-divider></mat-divider>
        <h4>Quick Navigation</h4>
        <div class="nav-buttons">
          <button 
            mat-raised-button 
            color="primary"
            (click)="navigateToStructure()">
            <mat-icon>account_tree</mat-icon>
            View Structure Analysis
          </button>
          <button 
            mat-raised-button 
            color="primary"
            (click)="navigateToVisualization()">
            <mat-icon>bubble_chart</mat-icon>
            Network Visualization
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Error Display Card -->
  <mat-card *ngIf="error && !isLoading" class="error-card">
    <mat-card-content>
      <div class="error-content">
        <mat-icon class="error-icon">error</mat-icon>
        <div class="error-details">
          <h3>Processing Error</h3>
          <p>{{ error }}</p>
          <div class="error-actions">
            <button mat-raised-button color="warn" (click)="clearFile()">
              <mat-icon>refresh</mat-icon>
              Start Over
            </button>
            <button mat-stroked-button (click)="reprocessFile()" *ngIf="currentFile">
              <mat-icon>replay</mat-icon>
              Retry Processing
            </button>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

</div>